<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSH Meme Gallery - BT25CSH (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Modern scroll behavior and hiding scrollbars */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; background-color: #f8fafc; }
        .scroll-container { scroll-behavior: smooth; overflow-x: scroll; }
        .snap-full { min-width: 100%; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom gradient for hero elements */
        .admin-gradient { background-image: linear-gradient(to right, #1d4ed8, #4f46e5); }
        .upload-gradient { background-image: linear-gradient(to right, #6d28d9, #9333ea); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // --- SUPABASE CLIENT IMPORT ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // =================================================================
        // !!! üö® ACTION REQUIRED: REPLACE THESE PLACEHOLDERS üö® !!!
        // =================================================================
        const supabaseUrl = 'https://vspbfgmfszadpbegmous.supabase.co'; 
        // Use your Supabase 'anon' key here
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzcGJmZ21mc3phZHBiZWdtb3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTg3MTMsImV4cCI6MjA3NzU5NDcxM30.Phjr2R8e22YH8PNUCP0Ls-_gE8pSRIFel34bvbJCUoQ';

        // --- INITIALIZE SUPABASE CLIENT ---
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // --- GLOBAL ICONS ---
        const icons = {
            User: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`,
            LockClosed: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-4a2 2 0 00-2-2H6a2 2 0 00-2 2v4a2 2 0 002 2z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6a3 3 0 013-3h.01a3 3 0 013 3v2h-6V6z" /></svg>`,
            X: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`,
            ArrowLeft: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>`,
            ArrowRight: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>`,
            Upload: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`,
            Collection: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0v1h10V7m0 0H7" /></svg>`,
            Heart: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`,
            Trophy: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 10h.01M12 10h.01M7 10h.01M21 12l-7-7M3 12l7-7m0 0l-4 4-3-3m0 0l-4 4-3-3m7 0h.01M21 12l-7-7" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21V11M9 18h6" /></svg>`,
            Bell: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>`,
            Trash: (size) => `<svg xmlns="http://www.w3.org/2000/svg" class="h-${size} w-${size}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`,
        };

        class MemeGallery {
            constructor() {
                this.root = document.getElementById('root');
                this.state = {
                    userEmail: '',
                    isAdmin: false, // Full Admin (050)
                    isNoticesAdmin: false, // Notice Admin (050 or 051)
                    showLogin: false,
                    email: '',
                    password: '',
                    currentTab: 'memes', // 'memes', 'memories', 'notices'
                    memes: [],
                    memories: [],
                    hallOfFameMemes: [],
                    hallOfFameMemories: [],
                    notices: [],
                    uploadStatus: '',
                    memeScrollIndex: 0,
                    memoryScrollIndex: 0,
                    memeScrollInterval: null,
                    memoryScrollInterval: null,
                };
                
                this.init();
            }

            async init() {
                // Check if user is logged in
                await this.checkAuth();
                
                // Load initial data
                await this.loadAllData();
                
                // Start auto-scroll for Hall of Fame
                this.startAutoScroll();

                // Initial render
                this.render();
            }

            // --- STATE MANAGEMENT ---

            async checkAuth() {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    this.state.userEmail = user.email;
                    this.state.isAdmin = user.email === 'bt25csh050@iiitn.ac.in';
                    this.state.isNoticesAdmin = this.state.isAdmin || user.email === 'bt25csh051@iiitn.ac.in';
                } else {
                    this.state.userEmail = '';
                    this.state.isAdmin = false;
                    this.state.isNoticesAdmin = false;
                }
            }
            
            async loadAllData() {
                await Promise.all([
                    this.loadMemes(),
                    this.loadMemories(),
                    this.loadNotices()
                ]);
            }

            // --- DATA LOADERS ---

            async loadMemes() {
                const { data: memes, error } = await supabase
                    .from('memes')
                    .select('*')
                    .order('createdAt', { ascending: false });

                if (error) {
                    console.error('Error loading memes:', error);
                    return;
                }
                
                this.state.memes = memes;
                this.state.hallOfFameMemes = memes.filter(m => m.hallOfFame).sort((a, b) => b.votes - a.votes);
            }

            async loadMemories() {
                const { data: memories, error } = await supabase
                    .from('memories')
                    .select('*')
                    .order('createdAt', { ascending: false });

                if (error) {
                    console.error('Error loading memories:', error);
                    return;
                }

                this.state.memories = memories;
                this.state.hallOfFameMemories = memories.filter(m => m.hallOfFame).sort((a, b) => b.votes - a.votes);
            }
            
            async loadNotices() {
                 const { data: notices, error } = await supabase
                    .from('notices')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error('Error loading notices:', error);
                    return;
                }
                
                this.state.notices = notices;
            }

            // --- AUTH HANDLERS ---

            async handleLogin(e) {
                e.preventDefault();
                const email = this.state.email;
                const password = this.state.password;
                
                this.state.uploadStatus = 'Logging in...';
                this.render();

                const { error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    this.state.uploadStatus = `Login failed: ${error.message}`;
                    console.error('Login error:', error);
                } else {
                    await this.checkAuth();
                    this.state.showLogin = false;
                    this.state.uploadStatus = 'Login successful!';
                    await this.loadAllData();
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async handleLogout() {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Logout error:', error);
                } else {
                    this.state.userEmail = '';
                    this.state.isAdmin = false;
                    this.state.isNoticesAdmin = false;
                    this.state.uploadStatus = 'Logged out.';
                    this.loadAllData();
                }
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            // --- FILE AND DB HANDLERS ---
            // üöÄ FIX: Enhanced with DEBUG LOGGING to find where the upload is stalling
            async handleFileUpload(file, type) {
                // 1. DEBUG: Log the start
                console.log(`[DEBUG UPLOAD] Starting handleFileUpload for ${type}.`);
                
                if (!file) {
                    console.error('[DEBUG UPLOAD] Error: No file object received.');
                    return;
                }

                // 2. DEBUG: Log file details
                console.log(`[DEBUG UPLOAD] File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

                const fileExt = file.name.split('.').pop();
                const filePath = `${type}s/${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
                
                this.state.uploadStatus = `Uploading ${type}...`; // This is the status they see
                this.render();

                // 3. DEBUG: Log before the critical Supabase storage call
                console.log(`[DEBUG UPLOAD] Attempting storage upload to path: ${filePath}`);

                // --- SUPABASE STORAGE UPLOAD ---
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('gallery')
                    .upload(filePath, file);

                // 4. DEBUG: Log after the critical call
                console.log('[DEBUG UPLOAD] Supabase storage upload response received.');

                if (uploadError) {
                    this.state.uploadStatus = `Upload failed: ${uploadError.message}`;
                    console.error('Upload error (Storage):', uploadError);
                    this.render();
                    return;
                }

                const publicURL = `${supabaseUrl}/storage/v1/object/public/gallery/${filePath}`;

                // 5. DEBUG: Log before DB insertion
                console.log('[DEBUG UPLOAD] Attempting DB insertion...');

                const { error: dbError } = await supabase
                    .from(`${type}s`)
                    .insert({ 
                        url: publicURL, 
                        uploadedBy: this.state.userEmail,
                        createdAt: new Date().toISOString()
                    });
                    
                // 6. DEBUG: Log after DB insertion
                console.log('[DEBUG UPLOAD] DB insertion completed.');


                if (dbError) {
                    this.state.uploadStatus = `Database save failed: ${dbError.message}`;
                    console.error('DB error:', dbError);
                    // Attempt to clean up the storage file if DB save fails
                    await supabase.storage.from('gallery').remove([filePath]);
                } else {
                    this.state.uploadStatus = `${type} uploaded and saved!`;
                    await this.loadAllData();
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async handleVote(id, type) {
                // Ensure only one vote per session/user is simple enough for this scope
                const table = `${type}s`;
                const item = this.state[`${table}`].find(i => i.id === id);
                if (!item) return;

                this.state.uploadStatus = 'Casting vote...';
                this.render();
                
                const newVotes = item.votes + 1;
                
                const { error } = await supabase
                    .from(table)
                    .update({ votes: newVotes })
                    .eq('id', id);

                if (error) {
                    this.state.uploadStatus = `Voting failed: ${error.message}`;
                    console.error('Vote error:', error);
                } else {
                    this.state.uploadStatus = 'Vote successful!';
                    await this.loadAllData();
                }

                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async promoteToHallOfFame(item, type) {
                if (!this.state.isAdmin) return;

                const table = `${type}s`;
                
                this.state.uploadStatus = `Promoting ${type}...`;
                this.render();

                const { error } = await supabase
                    .from(table)
                    .update({ hallOfFame: true })
                    .eq('id', item.id);
                
                if (error) {
                    this.state.uploadStatus = `Promotion failed: ${error.message}`;
                    console.error('Promotion error:', error);
                } else {
                    this.state.uploadStatus = 'Promoted to Hall of Fame!';
                    await this.loadAllData();
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async removeFromHallOfFame(id, type) {
                if (!this.state.isAdmin) return;

                const table = `${type}s`;
                
                this.state.uploadStatus = `Removing ${type} from HoF...`;
                this.render();

                const { error } = await supabase
                    .from(table)
                    .update({ hallOfFame: false })
                    .eq('id', id);
                
                if (error) {
                    this.state.uploadStatus = `Removal failed: ${error.message}`;
                    console.error('Removal error:', error);
                } else {
                    this.state.uploadStatus = 'Removed from Hall of Fame.';
                    await this.loadAllData();
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async handleDeleteItem(id, type) {
                if (!this.state.isAdmin) return;
                
                const table = `${type}s`;
                const item = this.state[`${table}`].find(i => i.id === id);
                if (!item) return;

                this.state.uploadStatus = `Deleting ${type} and file...`;
                this.render();

                try {
                    // 1. Delete from storage
                    const filePath = item.url.split('gallery/')[1];
                    const { error: storageError } = await supabase.storage
                        .from('gallery')
                        .remove([filePath]);
                    
                    if (storageError) {
                        console.error('Storage deletion error:', storageError);
                        // Do not throw, continue to delete DB record
                    }

                    // 2. Delete from database
                    const { error: dbError } = await supabase
                        .from(table)
                        .delete()
                        .eq('id', id);

                    if (dbError) {
                        this.state.uploadStatus = `Database deletion failed: ${dbError.message}`;
                        console.error('DB deletion error:', dbError);
                        throw dbError;
                    }
                    
                    this.state.uploadStatus = `${type} deleted permanently.`;
                    await this.loadAllData();
                    
                } catch (err) {
                    this.state.uploadStatus = `Deletion failed: ${err.message}`;
                    console.error('Final deletion error:', err);
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }
            
            // --- NOTICES HANDLERS (Admin 050 & 051) ---

            async handleAddNotice(content) {
                if (!this.state.isNoticesAdmin || content.trim().length === 0) return;
                
                this.state.uploadStatus = 'Posting notice...';
                this.render();

                try {
                    // 1. Check current count and enforce limit (pop oldest)
                    if (this.state.notices.length >= 10) {
                        // Find the notice with the smallest timestamp (oldest)
                        const oldestNotice = this.state.notices.sort((a, b) => a.timestamp - b.timestamp)[this.state.notices.length - 1];
                        await supabase.from('notices').delete().eq('id', oldestNotice.id);
                    }

                    // 2. Insert new notice
                    const { error } = await supabase
                        .from('notices')
                        .insert([
                            {
                                content: content.trim(), 
                                uploadedBy: this.state.userEmail,
                                timestamp: Date.now() 
                            }
                        ]);

                    if (error) throw error;
                        
                    this.state.uploadStatus = 'Announcement posted!';
                    document.getElementById('noticeContentInput').value = ''; // Clear input
                    await this.loadNotices();
                } catch (err) {
                    this.state.uploadStatus = `Post failed: ${err.message}`;
                    console.error('Notice post error:', err);
                }
                
                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 3000);
            }

            async handleDeleteNotice(id) {
                // 1. DEBUG: Check Admin Status
                console.log(`[DEBUG] Attempting to delete notice ID: ${id}`);
                console.log(`[DEBUG] isNoticesAdmin status: ${this.state.isNoticesAdmin}`);

                if (!this.state.isNoticesAdmin) {
                    console.error("DEBUG ERROR: Admin check failed. Delete request blocked.");
                    return; 
                }

                this.state.uploadStatus = 'Deleting notice...';
                this.render();

                try {
                    // üöÄ CRITICAL FIX: The filter (.eq) must come before the action (.delete)
                    const { error } = await supabase
                        .from('notices')
                        .eq('id', id)  // Find the row to delete
                        .delete();    // Execute the delete operation

                    if (error) {
                        // If Supabase returns an error object, log it directly before throwing
                        console.error("[SUPABASE ERROR]: The request returned an error object.", error);
                        throw error;
                    }
                    
                    // Success path
                    this.state.uploadStatus = 'Notice deleted successfully.';
                    this.loadNotices(); 
                    setTimeout(() => {
                        this.state.uploadStatus = '';
                        this.render();
                    }, 3000);

                } catch (err) {
                    // 2. DEBUG: Catch and Log ALL Error Details
                    this.state.uploadStatus = `Deletion failed: ${err.message}. Check browser console (F12) for full error details.`;
                    console.error('------------------------------------------');
                    console.error('FINAL NOTICE DELETION FAILED:', err);
                    console.error('SUPABASE CODE (if available):', err.code || 'N/A');
                    console.error('SUPABASE DETAILS (if available):', err.details || 'N/A');
                    console.error('------------------------------------------');
                }
                this.render();
            }

            // --- ADMIN WIPE ---

            async handleWipeAndArchive() {
                if (!this.state.isAdmin) return;

                if (!confirm("FULL ADMIN WARNING: This will permanently delete ALL memes/memories NOT in the Hall of Fame and clear all votes. Proceed?")) {
                    return;
                }
                
                this.state.uploadStatus = 'Wiping data...';
                this.render();

                try {
                    // 1. Reset votes on Hall of Fame items
                    const { error: resetMemeError } = await supabase
                        .from('memes')
                        .update({ votes: 0 })
                        .eq('hallOfFame', true);
                    
                    const { error: resetMemoryError } = await supabase
                        .from('memories')
                        .update({ votes: 0 })
                        .eq('hallOfFame', true);
                    
                    if (resetMemeError || resetMemoryError) throw new Error('Failed to reset votes.');

                    // 2. Delete non-HoF items
                    const { error: deleteMemeError } = await supabase
                        .from('memes')
                        .delete()
                        .eq('hallOfFame', false);

                    const { error: deleteMemoryError } = await supabase
                        .from('memories')
                        .delete()
                        .eq('hallOfFame', false);
                        
                    if (deleteMemeError || deleteMemoryError) throw new Error('Failed to delete non-HoF items.');

                    this.state.uploadStatus = 'Gallery wiped and HoF votes reset successfully!';
                    await this.loadAllData();

                } catch (err) {
                    this.state.uploadStatus = `Wipe failed: ${err.message}`;
                    console.error('Wipe error:', err);
                }

                setTimeout(() => {
                    this.state.uploadStatus = '';
                    this.render();
                }, 5000);
            }

            // --- RENDER METHODS ---

            renderLoginModal() {
                if (!this.state.showLogin) return '';

                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
                            <div class="flex justify-between items-start mb-6">
                                <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">${icons.LockClosed(6)} Admin Login</h2>
                                <button id="closeLogin" class="text-gray-400 hover:text-gray-600">${icons.X(6)}</button>
                            </div>
                            <form id="loginForm">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email (e.g., bt25csh050@iiitn.ac.in)</label>
                                    <input type="email" id="emailInput" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="passwordInput" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <button id="loginBtn" class="admin-gradient text-white w-full py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg flex items-center justify-center gap-2">
                                    ${icons.User(6)} Log In
                                </button>
                            </form>
                            <p class="mt-4 text-center text-xs text-gray-500">Only authorized CSH batch accounts can log in.</p>
                        </div>
                    </div>
                `;
            }

            renderHeader() {
                const isAdmin = this.state.isAdmin;
                const isNoticesAdmin = this.state.isNoticesAdmin;
                const isLoggedIn = this.state.userEmail;

                return `
                    <header class="bg-white shadow-md sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div class="flex justify-between items-center">
                                <h1 class="text-3xl font-extrabold text-indigo-600 tracking-tighter flex items-center gap-2">
                                    ${icons.Collection(8)} CSH Gallery
                                </h1>
                                
                                <div class="flex items-center gap-4">
                                    ${isLoggedIn ? `
                                        <span class="text-sm font-medium text-gray-600 hidden sm:inline-block">Logged in as: ${this.state.userEmail}</span>
                                        <button id="logoutBtn" class="text-white bg-red-500 px-4 py-2 rounded-full text-sm font-semibold hover:bg-red-600 transition shadow-md">
                                            Logout
                                        </button>
                                    ` : `
                                        <button id="showLoginBtn" class="admin-gradient text-white px-4 py-2 rounded-full text-sm font-semibold hover:opacity-90 transition shadow-md flex items-center gap-1">
                                            ${icons.LockClosed(4)} Admin
                                        </button>
                                    `}
                                </div>
                            </div>
                            
                            <nav class="mt-4 border-t border-gray-200 pt-3">
                                <div class="flex space-x-4">
                                    ${this.renderTabButton('memes', 'Memes')}
                                    ${this.renderTabButton('memories', 'Memories')}
                                    ${this.renderTabButton('notices', 'Notices')}
                                </div>
                            </nav>
                        </div>
                    </header>
                `;
            }

            renderTabButton(tabName, label) {
                const isActive = this.state.currentTab === tabName;
                const activeClasses = 'bg-indigo-600 text-white shadow-lg';
                const inactiveClasses = 'text-gray-600 hover:bg-gray-100 hover:text-indigo-600';
                
                return `
                    <button data-tab="${tabName}" class="px-6 py-2 rounded-full text-sm font-bold transition ${isActive ? activeClasses : inactiveClasses}">
                        ${label}
                    </button>
                `;
            }

            renderHallOfFame(items, type) {
                if (items.length === 0) {
                    return `<div class="text-center py-6 text-gray-500">No items in the Hall of Fame yet!</div>`;
                }

                const scrollContainerId = `${type}-scroll-container`;
                const scrollIndex = type === 'meme' ? this.state.memeScrollIndex : this.state.memoryScrollIndex;

                return `
                    <div class="relative overflow-hidden rounded-xl shadow-2xl bg-white border-2 border-indigo-500/50">
                        <div id="${scrollContainerId}" class="scroll-container flex snap-x snap-mandatory" style="transform: translateX(-${scrollIndex * 100}%)">
                            ${items.map((item, index) => {
                                const isVideo = item.url.match(/\.(mp4|mov|webm)$/i);
                                return `
                                    <div class="snap-start snap-full flex-shrink-0 p-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center text-sm font-bold text-indigo-700">
                                                ${icons.Trophy(6)} 
                                                <span class="ml-2 tracking-widest uppercase">HALL OF FAME</span>
                                            </div>
                                            <span class="text-sm font-medium text-gray-500">Votes: ${item.votes}</span>
                                        </div>
                                        <div class="flex justify-center items-center h-[400px] bg-gray-100 rounded-xl overflow-hidden shadow-inner">
                                            ${isVideo ? `
                                                <video class="max-h-full max-w-full object-contain" src="${item.url}" controls loop></video>
                                            ` : `
                                                <img class="max-h-full max-w-full object-contain" src="${item.url}" alt="HoF ${type}">
                                            `}
                                        </div>
                                        <div class="mt-4 flex justify-between items-center">
                                            <span class="text-sm text-gray-500">Uploaded by: ${item.uploadedBy}</span>
                                            ${this.state.isAdmin ? `
                                                <button data-remove-hof="${item.id}" data-type="${type}" class="flex items-center gap-1 bg-red-500 text-white px-3 py-1.5 text-xs rounded-xl font-semibold hover:bg-red-600 transition shadow-md">
                                                    ${icons.X(4)} Remove
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${items.length > 1 ? `
                            <button data-scroll="${type}" data-direction="prev" class="absolute left-3 top-1/2 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-lg hover:bg-white transition text-indigo-600">
                                ${icons.ArrowLeft(6)}
                            </button>
                            <button data-scroll="${type}" data-direction="next" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-lg hover:bg-white transition text-indigo-600">
                                ${icons.ArrowRight(6)}
                            </button>
                        ` : ''}
                        
                        <div class="absolute bottom-3 left-0 right-0 flex justify-center space-x-2">
                            ${items.map((_, index) => `
                                <span class="block w-2 h-2 rounded-full ${index === scrollIndex ? 'bg-indigo-600' : 'bg-gray-300'} transition"></span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderGallery(items, type) {
                const isVideo = (url) => url.match(/\.(mp4|mov|webm)$/i);

                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${items.map(item => `
                            <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden flex flex-col">
                                <div class="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                                    ${isVideo(item.url) ? `
                                        <video class="w-full h-full object-cover" src="${item.url}" controls loop></video>
                                    ` : `
                                        <img class="w-full h-full object-cover" src="${item.url}" alt="${type}" loading="lazy">
                                    `}
                                </div>
                                <div class="p-4 flex flex-col flex-grow">
                                    <div class="flex items-center justify-between">
                                        <button data-vote-id="${item.id}" data-type="${type}" class="flex items-center gap-1 text-red-500 hover:text-red-700 transition">
                                            ${icons.Heart(6)} 
                                            <span class="text-lg font-bold">${item.votes}</span>
                                        </button>
                                        <span class="text-sm text-gray-500">by ${item.uploadedBy}</span>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                                        ${this.state.isAdmin ? `
                                            ${!item.hallOfFame ? `
                                                <button data-promote="${item.id}" data-type="${type}" class="flex items-center gap-1 admin-gradient text-white px-3 py-1.5 text-xs rounded-xl font-semibold hover:opacity-90 transition shadow-md">
                                                    ${icons.Trophy(4)} Promote
                                                </button>
                                            ` : `
                                                <span class="text-sm text-indigo-600 font-semibold flex items-center gap-1">${icons.Trophy(4)} In HoF</span>
                                            `}
                                            <button data-delete-item="${item.id}" data-type="${type}" class="flex items-center gap-1 bg-red-600 text-white px-3 py-1.5 text-xs rounded-xl font-semibold hover:bg-red-700 transition shadow-md">
                                                ${icons.Trash(4)} Delete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderMemesTab() {
                const showUpload = this.state.userEmail && this.state.currentTab === 'memes';

                return `
                    <div class="max-w-7xl mx-auto py-8">
                        <div class="flex items-center gap-4 mb-8">
                            <span class="text-4xl">üòÇ</span>
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Meme Hall of Fame</h2>
                        </div>
                        ${this.renderHallOfFame(this.state.hallOfFameMemes, 'meme')}

                        <div class="flex items-center gap-4 mt-12 mb-8">
                            <span class="text-4xl">üñºÔ∏è</span>
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Latest Uploads</h2>
                        </div>
                        
                        ${showUpload ? `
                            <div class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-8 flex justify-between items-center">
                                <label for="fileInputMeme" class="upload-gradient text-white px-6 py-3 rounded-full font-bold cursor-pointer hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    ${icons.Upload(6)} Upload New Meme
                                </label>
                                <input type="file" id="fileInputMeme" data-type="meme" accept="image/*,video/mp4,video/webm" class="hidden">
                                <button id="showLoginBtn_gated" class="text-indigo-600 font-semibold hover:underline">Or Login to upload</button>
                            </div>
                        ` : ''}

                        ${this.state.memes.length === 0 ? `
                            <div class="text-center py-16 bg-white rounded-xl shadow-lg border-2 border-gray-200">
                                <p class="text-gray-600 text-xl font-medium">No memes yet! Be the first to upload.</p>
                            </div>
                        ` : this.renderGallery(this.state.memes.filter(m => !m.hallOfFame), 'meme')}
                    </div>
                `;
            }

            renderMemoriesTab() {
                const showUpload = this.state.userEmail && this.state.currentTab === 'memories';

                return `
                    <div class="max-w-7xl mx-auto py-8">
                        <div class="flex items-center gap-4 mb-8">
                            <span class="text-4xl">üì∏</span>
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Memory Hall of Fame</h2>
                        </div>
                        ${this.renderHallOfFame(this.state.hallOfFameMemories, 'memory')}

                        <div class="flex items-center gap-4 mt-12 mb-8">
                            <span class="text-4xl">üìî</span>
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Latest Uploads</h2>
                        </div>

                        ${showUpload ? `
                            <div class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-8 flex justify-between items-center">
                                <label for="fileInputMemory" class="upload-gradient text-white px-6 py-3 rounded-full font-bold cursor-pointer hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    ${icons.Upload(6)} Upload New Memory
                                </label>
                                <input type="file" id="fileInputMemory" data-type="memory" accept="image/*,video/mp4,video/webm" class="hidden">
                                <button id="showLoginBtn_gated" class="text-indigo-600 font-semibold hover:underline">Or Login to upload</button>
                            </div>
                        ` : ''}
                        
                        ${this.state.memories.length === 0 ? `
                            <div class="text-center py-16 bg-white rounded-xl shadow-lg border-2 border-gray-200">
                                <p class="text-gray-600 text-xl font-medium">No memories yet! Share your batch journey.</p>
                            </div>
                        ` : this.renderGallery(this.state.memories.filter(m => !m.hallOfFame), 'memory')}
                    </div>
                `;
            }
            
            renderNoticesTab() {
                const isNoticesAdmin = this.state.isNoticesAdmin;
                
                return `
                    <div class="max-w-4xl mx-auto py-8">
                        <div class="flex items-center gap-4 mb-8">
                            ${icons.Bell(8)}
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Community Notices</h2>
                        </div>
                        
                        ${isNoticesAdmin ? `
                            <div class="bg-white rounded-2xl p-6 shadow-xl mb-10 border-4 border-indigo-200/50">
                                <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
                                    Post New Notice 
                                    <span class="ml-auto text-sm font-medium text-gray-500">
                                        Limit: ${this.state.notices.length}/10
                                    </span>
                                </h3>
                                <textarea id="noticeContentInput" class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition resize-none" rows="4" placeholder="Type your important announcement here..."></textarea>
                                <div class="flex justify-between items-center mt-4">
                                    <p class="text-sm text-gray-500">Posting as: ${this.state.userEmail}</p>
                                    <button id="postNoticeBtn" class="admin-gradient text-white px-8 py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                                        Post Announcement
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${this.state.notices.length === 0 ? `
                            <div class="text-center py-16 bg-white rounded-2xl shadow-xl border-2 border-gray-200">
                                <p class="text-gray-600 text-xl font-medium">No announcements yet. Check back soon!</p>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                ${this.state.notices.map((notice, index) => {
                                    const isTop = index === 0;
                                    const bgColor = isTop ? 'bg-indigo-600 text-white shadow-2xl ring-4 ring-indigo-300/50' : 'bg-white text-gray-800 shadow-lg border border-gray-200 hover:shadow-xl';
                                    const headerColor = isTop ? 'text-indigo-200' : 'text-indigo-600';
                                    
                                    // üöÄ FIX APPLIED HERE: Correctly parse the BigInt/number timestamp
                                    const dateObj = new Date(Number(notice.timestamp)); 
                                    const timestamp = dateObj.toLocaleDateString('en-US', {
                                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                    });

                                    return `
                                        <div class="p-6 rounded-2xl ${bgColor} transition duration-300">
                                            <div class="flex items-start justify-between mb-3">
                                                <p class="text-sm font-extrabold ${headerColor} tracking-widest uppercase flex items-center gap-2">
                                                    ${isTop ? '‚ú® LATEST ANNOUNCEMENT' : 'COMMUNITY UPDATE'}
                                                </p>
                                                <p class="text-xs ${isTop ? 'text-indigo-200' : 'text-gray-500'} font-medium">${timestamp}</p>
                                            </div>
                                            <p class="text-xl font-bold whitespace-pre-wrap leading-relaxed">${notice.content}</p>
                                            
                                            <div class="flex items-center justify-between mt-4 border-t ${isTop ? 'border-indigo-500/50' : 'border-gray-200'} pt-3">
                                                <span class="text-sm ${isTop ? 'text-indigo-300' : 'text-gray-500'}">Posted by: ${notice.uploadedBy}</span>
                                                ${isNoticesAdmin ? `
                                                    <button data-delete-notice="${notice.id}" class="flex items-center gap-1 bg-red-600 text-white px-3 py-1.5 text-xs rounded-xl font-semibold hover:bg-red-700 transition shadow-md">
                                                        ${icons.Trash(4)} Delete
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }

            renderFooter() {
                return `
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-12 border-t border-gray-200">
                        <div class="text-center text-sm text-gray-500">
                            CSH Meme & Memory Gallery | Built with Supabase & Tailwind CSS. 
                        </div>
                        ${this.state.isAdmin ? `
                            <div class="mt-4 text-center">
                                <button id="wipeAndArchiveBtn" class="bg-red-500 text-white px-4 py-2 rounded-full text-xs font-semibold hover:bg-red-600 transition shadow-md">
                                    ADMIN: Wipe Non-HoF Data
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderStatusBanner() {
                if (!this.state.uploadStatus) return '';
                
                const isError = this.state.uploadStatus.includes('failed') || this.state.uploadStatus.includes('Error');
                const bgColor = isError ? 'bg-red-500' : 'bg-indigo-600';

                return `
                    <div class="fixed bottom-0 right-0 m-6 p-4 rounded-xl shadow-2xl text-white font-bold transition duration-300 ${bgColor} z-50">
                        ${this.state.uploadStatus}
                    </div>
                `;
            }

            // --- MAIN RENDER LOOP ---
            render() {
                let content;
                switch (this.state.currentTab) {
                    case 'memories':
                        content = this.renderMemoriesTab();
                        break;
                    case 'notices':
                        content = this.renderNoticesTab();
                        break;
                    case 'memes':
                    default:
                        content = this.renderMemesTab();
                        break;
                }

                this.root.innerHTML = `
                    ${this.renderHeader()}
                    <main class="min-h-[70vh] px-4 sm:px-6 lg:px-8">
                        ${content}
                    </main>
                    ${this.renderFooter()}
                    ${this.renderLoginModal()}
                    ${this.renderStatusBanner()}
                `;

                this.attachEventListeners();
                
                // Manually trigger scroll after rendering HoF items
                const memeContainer = document.getElementById('meme-scroll-container');
                if (memeContainer) {
                    memeContainer.scrollLeft = memeContainer.clientWidth * this.state.memeScrollIndex;
                }
                const memoryContainer = document.getElementById('memory-scroll-container');
                if (memoryContainer) {
                    memoryContainer.scrollLeft = memoryContainer.clientWidth * this.state.memoryScrollIndex;
                }
            }
            
            // --- EVENT LISTENERS ---

            attachEventListeners() {
                // Modal
                const closeLogin = document.getElementById('closeLogin');
                if (closeLogin) closeLogin.onclick = () => { this.state.showLogin = false; this.render(); };

                const showLoginBtn = document.getElementById('showLoginBtn');
                const showLoginBtnGated = document.getElementById('showLoginBtn_gated');
                const showLogin = () => { this.state.showLogin = true; this.render(); };
                if (showLoginBtn) showLoginBtn.onclick = showLogin;
                if (showLoginBtnGated) showLoginBtnGated.onclick = showLogin;

                // Auth
                const loginForm = document.getElementById('loginForm');
                if (loginForm) loginForm.onsubmit = (e) => this.handleLogin(e);
                
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.onclick = (e) => this.handleLogin(e); 
                
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) logoutBtn.onclick = () => this.handleLogout();

                // Admin
                const wipeAndArchiveBtn = document.getElementById('wipeAndArchiveBtn');
                if (wipeAndArchiveBtn) wipeAndArchiveBtn.onclick = () => this.handleWipeAndArchive();
                
                // Notice Post Button
                const postNoticeBtn = document.getElementById('postNoticeBtn');
                if (postNoticeBtn) postNoticeBtn.onclick = () => {
                    const contentInput = document.getElementById('noticeContentInput');
                    if (contentInput) {
                        this.handleAddNotice(contentInput.value);
                    }
                };
                
                // Notice Delete Buttons (FIXED)
                document.querySelectorAll('[data-delete-notice]').forEach(btn => {
                    btn.onclick = () => {
                        const noticeId = parseInt(btn.getAttribute('data-delete-notice'));
                        if (isNaN(noticeId)) {
                             console.error("Invalid notice ID for deletion.");
                             return;
                        }
                        if (confirm('Are you sure you want to permanently delete this notice?')) {
                            this.handleDeleteNotice(noticeId);
                        }
                    };
                });

                // Item Delete Buttons (Memes/Memories)
                document.querySelectorAll('[data-delete-item]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-delete-item'));
                        const type = btn.getAttribute('data-type');
                        if (confirm(`ADMIN WARNING: Are you sure you want to permanently delete this ${type} and its file from storage?`)) {
                            this.handleDeleteItem(itemId, type);
                        }
                    };
                });
                
                // Form Inputs
                const emailInput = document.getElementById('emailInput');
                if (emailInput) emailInput.oninput = (e) => { this.state.email = e.target.value; };

                const passwordInput = document.getElementById('passwordInput');
                if (passwordInput) passwordInput.oninput = (e) => { this.state.password = e.target.value; };
                
                // Upload Inputs
                const fileInputMeme = document.getElementById('fileInputMeme');
                if (fileInputMeme) fileInputMeme.onchange = (e) => this.handleFileUpload(e.target.files[0], 'meme');

                const fileInputMemory = document.getElementById('fileInputMemory');
                if (fileInputMemory) fileInputMemory.onchange = (e) => this.handleFileUpload(e.target.files[0], 'memory');

                // Voting
                document.querySelectorAll('[data-vote-id]').forEach(btn => {
                    btn.onclick = () => {
                        if (!this.state.userEmail) {
                            alert("Please log in to cast a vote.");
                            this.state.showLogin = true;
                            this.render();
                            return;
                        }
                        const itemId = parseInt(btn.getAttribute('data-vote-id'));
                        const type = btn.getAttribute('data-type');
                        this.handleVote(itemId, type);
                    };
                });

                // Tabs
                document.querySelectorAll('[data-tab]').forEach(btn => {
                    btn.onclick = () => {
                        this.state.currentTab = btn.getAttribute('data-tab');
                        if (this.state.currentTab !== 'notices') {
                             this.loadAllData();
                        } else {
                            this.loadNotices();
                        }
                        this.render();
                    };
                });
                
                // HoF Scroll
                document.querySelectorAll('[data-scroll]').forEach(btn => {
                    btn.onclick = () => {
                        const type = btn.getAttribute('data-scroll');
                        const direction = btn.getAttribute('data-direction');
                        if (type === 'meme') {
                            this.scrollMemes(direction);
                        } else {
                            this.scrollMemories(direction);
                        }
                    };
                });

                // HoF Promote
                document.querySelectorAll('[data-promote]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-promote'));
                        const type = btn.getAttribute('data-type');
                        const items = type === 'memory' ? this.state.memories : this.state.memes;
                        const item = items.find(m => m.id === itemId);
                        if (item) this.promoteToHallOfFame(item, type);
                    };
                });

                // HoF Remove
                document.querySelectorAll('[data-remove-hof]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-remove-hof'));
                        const type = btn.getAttribute('data-type');
                        this.removeFromHallOfFame(itemId, type);
                    };
                });
            }

            // --- SCROLL LOGIC ---
            
            scrollMemes(direction) { 
                const container = document.getElementById('meme-scroll-container');
                if (!container) return;
                const totalItems = this.state.hallOfFameMemes.length;
                if (totalItems <= 1) return;

                let newIndex = this.state.memeScrollIndex;

                if (direction === 'next') {
                    newIndex = (newIndex + 1) % totalItems;
                } else if (direction === 'prev') {
                    newIndex = (newIndex - 1 + totalItems) % totalItems;
                }
                
                this.state.memeScrollIndex = newIndex;
                this.render(); 
            }

            scrollMemories(direction) { 
                const container = document.getElementById('memory-scroll-container');
                if (!container) return;
                const totalItems = this.state.hallOfFameMemories.length;
                if (totalItems <= 1) return;
                
                let newIndex = this.state.memoryScrollIndex;

                if (direction === 'next') {
                    newIndex = (newIndex + 1) % totalItems;
                } else if (direction === 'prev') {
                    newIndex = (newIndex - 1 + totalItems) % totalItems;
                }

                this.state.memoryScrollIndex = newIndex;
                this.render(); 
            }

            startAutoScroll() {
                // Clear any existing intervals
                if (this.memeScrollInterval) clearInterval(this.memeScrollInterval);
                if (this.memoryScrollInterval) clearInterval(this.memoryScrollInterval);

                // Start Meme Auto-Scroll
                this.memeScrollInterval = setInterval(() => {
                    if (this.state.currentTab === 'memes' && this.state.hallOfFameMemes.length > 1) {
                        this.scrollMemes('next');
                    }
                }, 5000);

                // Start Memory Auto-Scroll
                this.memoryScrollInterval = setInterval(() => {
                    if (this.state.currentTab === 'memories' && this.state.hallOfFameMemories.length > 1) {
                        this.scrollMemories('next');
                    }
                }, 5000);
            }
        }

        new MemeGallery();
    </script>
</body>
</html>
