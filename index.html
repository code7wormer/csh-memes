<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSH Meme Gallery - BT25CSH (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Modern scroll behavior and hiding scrollbars */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; background-color: #f8fafc; }
        .scroll-container { scroll-behavior: smooth; overflow-x: scroll; }
        .snap-full { min-width: 100%; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom gradient for hero elements */
        .admin-gradient { background-image: linear-gradient(to right, #1d4ed8, #4f46e5); }
        .upload-gradient { background-image: linear-gradient(to right, #6d28d9, #9333ea); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // --- SUPABASE CLIENT IMPORT ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // =================================================================
        // !!! ðŸš¨ ACTION REQUIRED: REPLACE YOUR_SUPABASE_PROJECT_URL ðŸš¨ !!!
        // =================================================================
        const supabaseUrl = 'https://vspbfgmfszadpbegmous.supabase.co'; 
        // NOTE: Use your Supabase 'anon' key here.
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzcGJmZ21mc3phZHBiZWdtb3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTg3MTMsImV4cCI6MjA3NzU5NDcxM30.Phjr2R8e22YH8PNUCP0Ls-_gE8pSRIFel34bvbJCUoQ'; 
        // =================================================================
        
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Lucide Icons
        const icons = {
            Upload: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`,
            LogOut: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            Star: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
            Image: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`,
            Lock: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
            Heart: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-500"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
            ChevronLeft: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
            ChevronRight: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
            Download: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            Trash: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            Bell: (size = 24) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`
        };

        // Helper function to extract the Storage file path from the full public URL
        function extractFilePath(url) {
            const parts = url.split('/storage/v1/object/public/gallery/');
            return parts.length > 1 ? parts[1] : null;
        }

        // Compress image to a Blob
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 1200; 
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Canvas to Blob conversion failed'));
                                }
                            },
                            'image/jpeg',
                            0.7
                        );
                    };
                    img.onerror = reject;
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                };
            });
        }


        class MemeGallery {
            constructor() {
                this.state = {
                    isLoggedIn: false,
                    isAdmin: false, 
                    isNoticesAdmin: false, 
                    userEmail: '',
                    email: '',
                    password: '',
                    currentTab: 'notices', 
                    hallOfFameMemes: [],
                    hallOfFameMemories: [],
                    memes: [],
                    memories: [],
                    notices: [], 
                    showLogin: false,
                    loading: true,
                    error: '',
                    uploadStatus: '',
                    memeScrollIndex: 0,
                    memoryScrollIndex: 0
                };
                this.memeScrollInterval = null;
                this.memoryScrollInterval = null;
                this.init();
            }

            async init() {
                await Promise.all([this.loadAllData(), this.loadNotices()]); 
                this.render();
                this.startAutoScroll();
            }
            
            async loadNotices() {
                const { data, error } = await supabase
                    .from('notices')
                    .select('id, content, uploadedBy, createdAt, timestamp')
                    .order('timestamp', { ascending: false });

                if (error) {
                    console.error('Error loading notices:', error);
                }
                this.state.notices = data || [];
                this.render(); 
            }


            async loadAllData() {
                this.state.loading = true;
                
                const fetchAll = async (table) => {
                    const { data, error } = await supabase
                        .from(table)
                        .select('id, imageUrl, uploadedBy, timestamp, is_hall_of_fame') 
                        .order('timestamp', { ascending: false });
                    if (error) {
                        console.error(`Error loading ${table}:`, error);
                        return [];
                    }
                    return data;
                };

                try {
                    const [allMemes, allMemories] = await Promise.all([
                        fetchAll('memes'),
                        fetchAll('memories')
                    ]);
                    
                    this.state.hallOfFameMemes = allMemes.filter(m => m.is_hall_of_fame);
                    this.state.memes = allMemes.filter(m => !m.is_hall_of_fame);
                    
                    this.state.hallOfFameMemories = allMemories.filter(m => m.is_hall_of_fame);
                    this.state.memories = allMemories.filter(m => !m.is_hall_of_fame);

                } catch (err) {
                    console.log('Error loading data:', err);
                }
                this.state.loading = false;
                this.render(); 
            }

            // --- REVISED LOGIN LOGIC ---
            handleLogin(e) {
                e.preventDefault();
                this.state.error = '';

                const emailLower = this.state.email.toLowerCase().trim();
                const password = this.state.password;
                const emailRegex = /^bt25csh\d{3}@iiitn\.ac\.in$/i;

                let expectedPassword = null;
                let isAdminCheck = false; 
                let isNoticesAdminCheck = false; 

                // Admin 050 (Full Admin + Notices)
                if (emailLower === 'bt25csh050@iiitn.ac.in') {
                    expectedPassword = 'wushangclanssSS11!!';
                    isAdminCheck = true;
                    isNoticesAdminCheck = true; 
                } 
                // Admin 051 (Notices Only)
                else if (emailLower === 'bt25csh051@iiitn.ac.in') {
                    expectedPassword = 'iambtechboy'; 
                    isAdminCheck = false;
                    isNoticesAdminCheck = true; 
                }
                // Regular User credentials
                else if (emailRegex.test(emailLower)) {
                    expectedPassword = 'cshgoated'; 
                    isAdminCheck = false;
                    isNoticesAdminCheck = false; 
                }
                
                if (!expectedPassword || password !== expectedPassword) {
                    this.state.error = 'Invalid credentials or email format.';
                    this.render();
                    return;
                }
                
                this.state.isLoggedIn = true;
                this.state.isAdmin = isAdminCheck;
                this.state.isNoticesAdmin = isNoticesAdminCheck;
                this.state.userEmail = emailLower; 
                this.state.showLogin = false;
                
                this.render();
            }

            handleLogout() {
                this.state.isLoggedIn = false;
                this.state.isAdmin = false;
                this.state.isNoticesAdmin = false; 
                this.state.userEmail = '';
                this.state.email = '';
                this.state.password = '';
                this.render();
            }

            // --- ADMIN WIPE AND ARCHIVE FUNCTION (UNCHANGED) ---
            async handleWipeAndArchive() {
                // ... (Logic remains the same) ...
                if (!this.state.isAdmin) return;
                
                const confirmation = confirm("ADMIN WARNING: This action will permanently DOWNLOAD ALL IMAGES (BACKUP) and then DELETE ALL DATA and FILES from both the database tables (memes/memories/notices) and the Storage bucket (gallery) to FREE UP SPACE. Are you absolutely sure?");

                if (!confirmation) {
                    this.state.uploadStatus = 'Wipe operation cancelled.';
                    this.render();
                    return;
                }

                this.state.uploadStatus = 'ARCHIVING: Preparing to download all files...';
                this.render();

                try {
                    const allMemes = await supabase.from('memes').select('imageUrl');
                    const allMemories = await supabase.from('memories').select('imageUrl');

                    const allUrls = [
                        ...allMemes.data.map(m => m.imageUrl),
                        ...allMemories.data.map(m => m.imageUrl)
                    ];
                    
                    const allFilePaths = allUrls
                        .map(extractFilePath)
                        .filter(path => path !== null);

                    if (allUrls.length === 0) {
                        this.state.uploadStatus = 'No files found. Deleting empty database tables...';
                    } else {
                        this.state.uploadStatus = `ARCHIVING: Initiating download of ${allUrls.length} files. Please allow multiple downloads in your browser... (This is your backup!)`;
                        this.render();

                        allUrls.forEach((url, index) => {
                            const a = document.createElement('a');
                            a.href = url;
                            const filename = url.substring(url.lastIndexOf('/') + 1);
                            a.download = `archive-${index}_${filename}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        });

                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                    
                    this.state.uploadStatus = `WIPE: Deleting ${allFilePaths.length} files from Storage to free up space...`;
                    this.render();
                    
                    if (allFilePaths.length > 0) {
                        const { error: storageDeleteError } = await supabase.storage
                            .from('gallery')
                            .remove(allFilePaths);

                        if (storageDeleteError) {
                            console.error('Storage wipe error:', storageDeleteError);
                        }
                    }

                    this.state.uploadStatus = 'WIPE: Deleting all database entries...';
                    this.render();
                    
                    const { error: memesDeleteError } = await supabase.from('memes').delete().neq('id', 0);
                    if (memesDeleteError) console.error('Meme table deletion failed. Check RLS.');

                    const { error: memoriesDeleteError } = await supabase.from('memories').delete().neq('id', 0);
                    if (memoriesDeleteError) console.error('Memory table deletion failed. Check RLS.');
                    
                    const { error: noticesDeleteError } = await supabase.from('notices').delete().neq('id', 0);
                    if (noticesDeleteError) console.error('Notices table deletion failed. Check RLS.');

                    this.state.uploadStatus = `ARCHIVE & WIPE SUCCESSFUL: ${allUrls.length} files archived and all data/files deleted. Space is now free!`;
                    this.loadAllData(); 
                    this.loadNotices(); 
                    
                } catch (err) {
                    this.state.uploadStatus = `WIPE FAILED: ${err.message}`;
                    console.error('Wipe operation failed:', err);
                    this.render();
                }
            }
            
            // --- NEW: DELETE INDIVIDUAL MEME/MEMORY FUNCTION (Admin 050 only) ---
            async handleDeleteItem(id, type) {
                if (!this.state.isAdmin) return;
                this.state.uploadStatus = `Deleting ${type}...`;
                this.render();

                try {
                    const table = type === 'memory' ? 'memories' : 'memes';
                    
                    // 1. Get the imageUrl to delete the file from storage
                    const { data: itemData, error: fetchError } = await supabase
                        .from(table)
                        .select('imageUrl')
                        .eq('id', id)
                        .single();

                    if (fetchError || !itemData) throw new Error('Item not found or fetch failed.');

                    const filePath = extractFilePath(itemData.imageUrl);

                    // 2. Delete the file from storage
                    if (filePath) {
                        const { error: storageError } = await supabase.storage
                            .from('gallery')
                            .remove([filePath]);
                        
                        if (storageError) console.error('Storage deletion error (non-fatal for DB cleanup):', storageError);
                    }

                    // 3. Delete the entry from the database
                    const { error: dbError } = await supabase
                        .from(table)
                        .delete()
                        .eq('id', id);

                    if (dbError) throw dbError;
                    
                    this.state.uploadStatus = `${type} deleted successfully.`;
                    this.loadAllData(); // Reload data
                    setTimeout(() => {
                        this.state.uploadStatus = '';
                        this.render();
                    }, 3000);

                } catch (err) {
                    this.state.uploadStatus = `Deletion failed: ${err.message}.`;
                    console.error('Item deletion error:', err);
                }
                this.render();
            }

            // --- DELETE INDIVIDUAL NOTICE FUNCTION (Admin 050 & 051) ---
            async handleDeleteNotice(id) {
                if (!this.state.isNoticesAdmin) return;
                // ... (Logic remains the same as previous step) ...
                this.state.uploadStatus = 'Deleting notice...';
                this.render();

                try {
                    const { error } = await supabase
                        .from('notices')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    this.state.uploadStatus = 'Notice deleted successfully.';
                    this.loadNotices(); 
                    setTimeout(() => {
                        this.state.uploadStatus = '';
                        this.render();
                    }, 3000);

                } catch (err) {
                    this.state.uploadStatus = `Deletion failed: ${err.message}.`;
                    console.error('Notice deletion error:', err);
                }
                this.render();
            }


            // --- ADD NOTICE FUNCTION (WITH 10-NOTICE LIMIT) ---
            async handleAddNotice(content) {
                if (!this.state.isNoticesAdmin || !content.trim()) return;
                // ... (Logic remains the same as previous step) ...
                this.state.uploadStatus = 'Posting notice...';
                this.render();

                try {
                    // 1. Check current count and enforce limit (pop oldest)
                    if (this.state.notices.length >= 10) {
                        this.state.uploadStatus = 'Notice limit reached (10). Deleting oldest notice...';
                        this.render();
                        
                        const oldestNotice = this.state.notices[this.state.notices.length - 1];
                        
                        const { error: deleteError } = await supabase
                            .from('notices')
                            .delete()
                            .eq('id', oldestNotice.id);
                            
                        if (deleteError) {
                            console.error('Failed to delete oldest notice. Inserting anyway:', deleteError);
                        }
                    }

                    // 2. Insert new notice
                    const { error } = await supabase
                        .from('notices')
                        .insert([
                            {
                                content: content.trim(),
                                uploadedBy: this.state.userEmail,
                                timestamp: Date.now(),
                            }
                        ]);

                    if (error) throw error;
                    
                    this.state.uploadStatus = 'Notice posted successfully! ðŸ“¢';
                    document.getElementById('noticeContentInput').value = '';
                    this.loadNotices();
                    setTimeout(() => {
                        this.state.uploadStatus = '';
                        this.render();
                    }, 3000);
                    
                } catch (err) {
                    this.state.uploadStatus = `Notice post failed: ${err.message}. Check RLS on 'notices' table.`;
                    console.error('Notice error:', err);
                }
                this.render();
            }

            // --- UPLOAD, PROMOTE, SCROLL (Retained/Adapted) ---
            async handleFileUpload(file, type) {
                // ... (Logic remains the same) ...
                if (!this.state.isLoggedIn) {
                    this.state.uploadStatus = 'Please log in to upload.'; 
                    this.render(); 
                    return;
                }
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    this.state.uploadStatus = 'Please upload an image file'; this.render(); return;
                }
                if (file.size > 5 * 1024 * 1024) { 
                    this.state.uploadStatus = 'Original image must be less than 5MB (we will compress it)'; this.render(); return;
                }

                this.state.uploadStatus = 'Compressing image...'; this.render();

                try {
                    const compressedBlob = await compressImage(file);
                    this.state.uploadStatus = 'Uploading to storage...'; this.render();

                    const timestamp = Date.now();
                    const collectionName = type === 'memory' ? 'memories' : 'memes';
                    const fileName = `${collectionName}/${timestamp}-${file.name.replace(/[^a-z0-9.]/gi, '_')}`; 
                    
                    const { error: storageError } = await supabase.storage
                        .from('gallery')
                        .upload(fileName, compressedBlob, { cacheControl: '3600', upsert: false });

                    if (storageError) throw storageError;

                    const { data: publicUrlData } = supabase.storage
                        .from('gallery')
                        .getPublicUrl(fileName);
                    
                    const downloadURL = publicUrlData.publicUrl;

                    this.state.uploadStatus = 'Saving metadata to database...'; this.render();

                    const { error: dbError } = await supabase
                        .from(collectionName)
                        .insert([{ 
                            imageUrl: downloadURL,
                            uploadedBy: this.state.userEmail, 
                            timestamp: timestamp,
                            is_hall_of_fame: false 
                        }]);

                    if (dbError) throw dbError;
                    
                    this.state.uploadStatus = `${type === 'memory' ? 'Memory' : 'Meme'} uploaded successfully! ðŸŽ‰`;
                    this.loadAllData();
                    setTimeout(() => {
                        this.state.uploadStatus = '';
                        this.render();
                    }, 3000);

                } catch (err) {
                    this.state.uploadStatus = `Upload failed: ${err.message}. Check RLS/Storage policies.`;
                    console.error('Upload error:', err);
                }
                this.render();
            }
            
            async promoteToHallOfFame(item, type) { 
                if (!this.state.isAdmin) return;
                try {
                    const sourceTable = type === 'memory' ? 'memories' : 'memes';
                    const { error } = await supabase
                        .from(sourceTable)
                        .update({ is_hall_of_fame: true })
                        .eq('id', item.id);
                    
                    if (error) throw error;
                    this.loadAllData(); 
                } catch (err) {
                    console.error('Failed to promote:', err);
                }
            }

            async removeFromHallOfFame(itemId, type) { 
                if (!this.state.isAdmin) return;
                try {
                    const sourceTable = type === 'memory' ? 'memories' : 'memes';
                    const { error } = await supabase
                        .from(sourceTable)
                        .update({ is_hall_of_fame: false })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    this.loadAllData(); 
                } catch (err) {
                    console.error('Failed to remove:', err);
                }
            }
            
            // --- RENDERING ---
            renderNoticesTab() {
                const isNoticesAdmin = this.state.isNoticesAdmin;
                
                return `
                    <div class="max-w-4xl mx-auto py-8">
                        <div class="flex items-center gap-4 mb-8">
                            ${icons.Bell(36)}
                            <h2 class="text-4xl font-extrabold text-gray-800 tracking-tight">Community Notices</h2>
                        </div>
                        
                        ${isNoticesAdmin ? `
                            <div class="bg-white rounded-2xl p-6 shadow-xl mb-10 border-4 border-indigo-200/50">
                                <h3 class="text-xl font-bold text-indigo-700 mb-4 flex items-center">
                                    Post New Notice 
                                    <span class="ml-auto text-sm font-medium text-gray-500">
                                        Limit: ${this.state.notices.length}/10
                                    </span>
                                </h3>
                                <textarea id="noticeContentInput" class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition resize-none" rows="4" placeholder="Type your important announcement here..."></textarea>
                                <div class="flex justify-between items-center mt-4">
                                    <p class="text-sm text-gray-500">Posting as: ${this.state.userEmail}</p>
                                    <button id="postNoticeBtn" class="admin-gradient text-white px-8 py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                                        Post Announcement
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${this.state.notices.length === 0 ? `
                            <div class="text-center py-16 bg-white rounded-2xl shadow-xl border-2 border-gray-200">
                                <p class="text-gray-600 text-xl font-medium">No announcements yet. Check back soon!</p>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                ${this.state.notices.map((notice, index) => {
                                    const isTop = index === 0;
                                    const bgColor = isTop ? 'bg-indigo-600 text-white shadow-2xl ring-4 ring-indigo-300/50' : 'bg-white text-gray-800 shadow-lg border border-gray-200 hover:shadow-xl';
                                    const headerColor = isTop ? 'text-indigo-200' : 'text-indigo-600';
                                    
                                    // NEW, safer block for BigInt timestamps:
                                    const dateObj = new Date(Number(notice.timestamp)); // Convert the BigInt/Number to a Date object
                                    const timestamp = dateObj.toLocaleDateString('en-US', {
                                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                    });

                                    return `
                                        <div class="p-6 rounded-2xl ${bgColor} transition duration-300">
                                            <div class="flex items-start justify-between mb-3">
                                                <p class="text-sm font-extrabold ${headerColor} tracking-widest uppercase flex items-center gap-2">
                                                    ${isTop ? 'âœ¨ LATEST ANNOUNCEMENT' : 'COMMUNITY UPDATE'}
                                                </p>
                                                <p class="text-xs ${isTop ? 'text-indigo-200' : 'text-gray-500'} font-medium">${timestamp}</p>
                                            </div>
                                            <p class="text-xl font-bold whitespace-pre-wrap leading-relaxed">${notice.content}</p>
                                            
                                            <div class="flex items-center justify-between mt-4 border-t ${isTop ? 'border-indigo-500/50' : 'border-gray-200'} pt-3">
                                                <span class="text-sm ${isTop ? 'text-indigo-300' : 'text-gray-500'}">Posted by: ${notice.uploadedBy}</span>
                                                ${isNoticesAdmin ? `
                                                    <button data-delete-notice="${notice.id}" class="flex items-center gap-1 bg-red-600 text-white px-3 py-1.5 text-xs rounded-xl font-semibold hover:bg-red-700 transition shadow-md">
                                                        ${icons.Trash(14)} Delete
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }


            renderMainPage() {
                const isMemeTab = this.state.currentTab === 'memes';
                const isMemoryTab = this.state.currentTab === 'memories';
                const isNoticesTab = this.state.currentTab === 'notices'; 

                const currentData = isMemeTab 
                    ? { hall: this.state.hallOfFameMemes, regular: this.state.memes, type: 'meme', color: 'purple' }
                    : { hall: this.state.hallOfFameMemories, regular: this.state.memories, type: 'memory', color: 'pink' };

                const tabColor = isMemeTab ? 'border-purple-600 text-purple-600' : 'border-pink-600 text-pink-600';
                const tabColorHover = isMemeTab ? 'hover:text-purple-600' : 'hover:text-pink-600';

                return `
                    <div class="min-h-screen bg-slate-50">
                        <nav class="bg-white shadow-lg sticky top-0 z-20">
                            <div class="max-w-7xl mx-auto px-4 py-4">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-4">
                                        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tighter">CSH Gallery</h1>
                                        <p class="text-sm text-gray-500 border-l pl-3">${this.state.isLoggedIn ? 'Access Granted' : 'Public View'}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        ${this.state.isAdmin ? `
                                            <button id="wipeAndArchiveBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition text-sm font-semibold shadow-md">
                                                ${icons.Download(16)} ${icons.Trash(16)}
                                                Archive & Wipe
                                            </button>
                                        ` : ''}
                                        ${!this.state.isLoggedIn ? `
                                            <button id="showLoginBtn" class="flex items-center gap-2 admin-gradient text-white px-4 py-2 rounded-xl hover:opacity-90 transition text-sm font-semibold shadow-md">
                                                ${icons.Lock(16)}
                                                Admin Login
                                            </button>
                                        ` : `
                                            <div class="flex items-center gap-3">
                                                ${this.state.isAdmin ? '<span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm">FULL ADMIN</span>' : this.state.isNoticesAdmin ? '<span class="bg-indigo-400 text-indigo-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm">NOTICE ADMIN</span>' : ''}
                                                <span class="text-sm text-gray-600 font-medium">${this.state.userEmail}</span>
                                                <button id="logoutBtn" class="flex items-center gap-2 bg-slate-200 text-gray-700 px-4 py-2 rounded-xl hover:bg-slate-300 transition text-sm font-semibold">
                                                    ${icons.LogOut(16)}
                                                    Logout
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <div class="flex gap-1">
                                    <button data-tab="notices" class="${isNoticesTab ? 'border-b-4 border-indigo-600 text-indigo-700' : 'text-gray-500 hover:text-indigo-600'} px-6 py-3 font-extrabold transition flex items-center text-lg">
                                        ${icons.Bell(20)}
                                        <span class="ml-2">Notices</span>
                                    </button>
                                    <button data-tab="memes" class="${isMemeTab ? `border-b-4 ${tabColor}` : `text-gray-500 ${tabColorHover}`} px-6 py-3 font-extrabold transition text-lg">
                                        Memes
                                    </button>
                                    <button data-tab="memories" class="${isMemoryTab ? `border-b-4 ${tabColor}` : `text-gray-500 ${tabColorHover}`} px-6 py-3 font-extrabold transition text-lg">
                                        Memories
                                    </button>
                                </div>
                            </div>
                        </nav>

                        <div class="max-w-7xl mx-auto px-4 py-12">
                            
                            ${isNoticesTab ? this.renderNoticesTab() : `
                                
                                <div class="mb-16">
                                    <div class="flex items-center gap-3 mb-6">
                                        ${isMemeTab ? icons.Star(36) : icons.Heart(36)}
                                        <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Hall of Fame</h2>
                                        <span class="text-sm text-gray-500 ml-auto">${isMemeTab ? 'The funniest memes ever.' : 'Memories that warm the heart.'}</span>
                                    </div>
                                    ${this.state.loading ? `
                                        <div class="text-center py-12 bg-white rounded-2xl shadow-lg"><p class="text-gray-600">Loading...</p></div>
                                    ` : this.renderScrollingHallOfFame(currentData.hall, currentData.type)}
                                </div>

                                ${this.state.uploadStatus ? `
                                    <div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-800 p-4 mb-10 rounded-lg shadow-md" role="alert">
                                        <p class="font-bold">Gallery Status</p>
                                        <p>${this.state.uploadStatus}</p>
                                    </div>
                                ` : ''}

                                ${this.state.isLoggedIn ? `
                                    
                                    <div class="mb-12 bg-white rounded-2xl p-8 shadow-xl border-4 ${isMemeTab ? 'border-purple-200/50' : 'border-pink-200/50'}">
                                        <h2 class="text-2xl font-bold text-gray-800 mb-5">Share Your ${isMemeTab ? 'Meme' : 'Memory'}</h2>
                                        <label class="flex items-center justify-center gap-3 upload-gradient text-white px-8 py-4 rounded-xl cursor-pointer transition font-extrabold text-lg hover:shadow-2xl hover:scale-[1.01] transform duration-300 shadow-xl">
                                            ${icons.Upload(24)}
                                            Choose ${isMemeTab ? 'Meme' : 'Memory'} File (Max 5MB)
                                            <input id="fileInput" type="file" accept="image/*" class="hidden">
                                        </label>
                                        <p class="text-sm text-gray-500 mt-3 text-center">Uploading as: ${this.state.userEmail}</p>
                                    </div>

                                    <div>
                                        <h2 class="text-3xl font-extrabold text-gray-800 mb-8 border-b pb-4">Latest ${isMemeTab ? 'Memes' : 'Memories'}</h2>
                                        ${currentData.regular.length === 0 ? `
                                            <div class="text-center py-20 bg-white rounded-2xl shadow-lg border-2 border-gray-200">
                                                ${icons.Image(72)}
                                                <p class="text-gray-600 text-xl font-medium mt-4">No ${this.state.currentTab} yet. Be the first to upload!</p>
                                            </div>
                                        ` : `
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                                                ${currentData.regular.map(item => `
                                                    <div class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition transform hover:-translate-y-1 relative group">
                                                        <div class="aspect-square bg-gray-100 flex items-center justify-center">
                                                            <img src="${item.imageUrl}" alt="${currentData.type}" class="w-full h-full object-contain">
                                                        </div>
                                                        <div class="p-4">
                                                            <p class="text-sm text-gray-700">By: <span class="font-bold">${item.uploadedBy}</span></p>
                                                            <p class="text-xs text-gray-500 mt-1">${new Date(item.timestamp).toLocaleDateString()}</p>
                                                        </div>
                                                        ${this.state.isAdmin ? `
                                                            <div class="absolute top-2 right-2 flex gap-2">
                                                                <button data-promote="${item.id}" data-type="${currentData.type}" class="bg-white text-gray-700 p-2 rounded-full text-xs flex items-center justify-center shadow-lg hover:scale-110 transition hover:text-black hover:bg-yellow-200/80">
                                                                    ${isMemeTab ? icons.Star(18) : icons.Heart(18)}
                                                                </button>
                                                                <button data-delete-item="${item.id}" data-type="${currentData.type}" class="bg-red-600 text-white p-2 rounded-full text-xs shadow-lg hover:bg-red-700 hover:scale-110 transition">
                                                                    ${icons.Trash(18)}
                                                                </button>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `}
                                    </div>
                                ` : `
                                    <div class="text-center py-20 bg-white rounded-2xl shadow-xl border-4 border-gray-300/50">
                                        ${icons.Lock(64)}
                                        <h3 class="text-3xl font-bold text-gray-700 mt-6">Login Required</h3>
                                        <p class="text-gray-500 mt-3 text-lg">Please log in to view the full gallery and upload content.</p>
                                        <button id="showLoginBtn_gated" class="mt-8 flex items-center gap-2 admin-gradient text-white px-8 py-3 rounded-xl hover:opacity-90 transition text-lg font-semibold mx-auto shadow-lg">
                                            ${icons.Lock(20)}
                                            Login Now
                                        </button>
                                    </div>
                                `}
                            `}
                        </div>
                    </div>
                `;
            }

            renderLoginModal() {
                 return `
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50">
                        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md relative transform transition-all scale-100 duration-300">
                            <button id="closeLogin" class="absolute top-5 right-5 text-gray-400 hover:text-gray-700 text-3xl transition">Ã—</button>
                            
                            <div class="text-center mb-10">
                                <h1 class="text-4xl font-extrabold text-gray-800 mb-2">CSH Login</h1>
                                <p class="text-gray-500 text-lg">Use your official BT25CSH credentials.</p>
                            </div>

                            <form id="loginForm" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Email</label>
                                    <input id="emailInput" type="email" value="${this.state.email}" placeholder="bt25cshXXX@iiitn.ac.in" class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                                    <input id="passwordInput" type="password" value="${this.state.password}" class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition">
                                </div>

                                ${this.state.error ? `<div class="bg-red-100 text-red-700 p-4 rounded-xl text-sm font-medium border border-red-200">${this.state.error}</div>` : ''}

                                <button id="loginBtn" class="w-full admin-gradient text-white py-3.5 rounded-xl font-bold text-lg hover:opacity-90 transition shadow-lg" type="submit">
                                    Sign In
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderScrollingHallOfFame(items, type) {
                 if (items.length === 0) {
                    return `
                        <div class="text-center py-16 bg-white rounded-2xl shadow-xl border-4 ${type === 'memory' ? 'border-pink-300/50' : 'border-yellow-300/50'}">
                            ${type === 'memory' ? icons.Heart(64) : icons.Star(64)}
                            <p class="text-gray-700 text-xl font-medium mt-4">No Hall of Fame ${type === 'memory' ? 'Memories' : 'Memes'} yet!</p>
                            ${this.state.isAdmin ? '<p class="text-sm text-gray-500 mt-2">Promote an item from the gallery below.</p>' : ''}
                        </div>
                    `;
                }

                const containerId = type === 'memory' ? 'memory-scroll-container' : 'meme-scroll-container';
                const borderColor = type === 'memory' ? 'border-pink-400' : 'border-yellow-400';
                const bgGradient = type === 'memory' ? 'from-pink-100 to-purple-100' : 'from-yellow-100 to-orange-100';

                return `
                    <div class="relative max-w-7xl mx-auto">
                        <div id="${containerId}" class="scroll-container overflow-x-scroll snap-x snap-mandatory relative rounded-2xl shadow-xl">
                            <div class="flex">
                                ${items.map(item => `
                                    <div class="snap-start snap-full px-2 py-1">
                                        <div class="bg-white rounded-2xl overflow-hidden shadow-2xl border-4 ${borderColor} relative mx-auto">
                                            <div class="aspect-[16/9] bg-gray-100 flex items-center justify-center">
                                                <img src="${item.imageUrl}" alt="Hall of Fame" class="w-full h-full object-contain">
                                            </div>
                                            <div class="p-5 flex items-center justify-between bg-gradient-to-r ${type === 'meme' ? 'from-yellow-50 to-orange-50' : 'from-pink-50 to-purple-50'}">
                                                <div>
                                                    <p class="text-xl font-bold text-gray-800">${type === 'meme' ? 'Hall of Fame Meme' : 'Golden Memory'}</p>
                                                    <p class="text-sm text-gray-600">By: <span class="font-semibold">${item.uploadedBy}</span> (${new Date(item.timestamp).toLocaleDateString()})</p>
                                                </div>
                                                ${this.state.isAdmin ? `
                                                    <button data-remove-hof="${item.id}" data-type="${type}" class="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-red-600 shadow-md transition">
                                                        Remove
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ${items.length > 1 ? `
                            <button data-scroll="${type}" data-direction="prev" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-full p-2.5 shadow-xl z-10 text-gray-700 hover:text-gray-900 transition ml-2">
                                ${icons.ChevronLeft(36)}
                            </button>
                            <button data-scroll="${type}" data-direction="next" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 hover:bg-opacity-100 rounded-full p-2.5 shadow-xl z-10 text-gray-700 hover:text-gray-900 transition mr-2">
                                ${icons.ChevronRight(36)}
                            </button>
                        ` : ''}
                    </div>
                `;
            }


            render() {
                const root = document.getElementById('root');
                
                if (this.state.showLogin) {
                    root.innerHTML = this.renderLoginModal();
                } else {
                    root.innerHTML = this.renderMainPage();
                }

                this.attachEventListeners();
                
                requestAnimationFrame(() => {
                    const memeContainer = document.getElementById('meme-scroll-container');
                    const memoryContainer = document.getElementById('memory-scroll-container');

                    if (memeContainer) {
                        const width = memeContainer.offsetWidth;
                        memeContainer.scrollLeft = width * this.state.memeScrollIndex;
                    }
                    if (memoryContainer) {
                        const width = memoryContainer.offsetWidth;
                        memoryContainer.scrollLeft = width * this.state.memoryScrollIndex;
                    }
                });
            }

            attachEventListeners() {
                const closeLogin = document.getElementById('closeLogin');
                if (closeLogin) closeLogin.onclick = () => { this.state.showLogin = false; this.render(); };

                const showLoginBtn = document.getElementById('showLoginBtn');
                const showLoginBtnGated = document.getElementById('showLoginBtn_gated');
                const showLogin = () => { this.state.showLogin = true; this.render(); };
                if (showLoginBtn) showLoginBtn.onclick = showLogin;
                if (showLoginBtnGated) showLoginBtnGated.onclick = showLogin;

                const loginForm = document.getElementById('loginForm');
                if (loginForm) loginForm.onsubmit = (e) => this.handleLogin(e);
                
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.onclick = (e) => this.handleLogin(e); 


                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) logoutBtn.onclick = () => this.handleLogout();
                
                // Admin Wipe Button
                const wipeAndArchiveBtn = document.getElementById('wipeAndArchiveBtn');
                if (wipeAndArchiveBtn) wipeAndArchiveBtn.onclick = () => this.handleWipeAndArchive();
                
                // New Notice Post Button
                const postNoticeBtn = document.getElementById('postNoticeBtn');
                if (postNoticeBtn) postNoticeBtn.onclick = () => {
                    const contentInput = document.getElementById('noticeContentInput');
                    if (contentInput) {
                        this.handleAddNotice(contentInput.value);
                    }
                };
                
                // ðŸš€ FIX APPLIED HERE: Notice Delete Buttons
                document.querySelectorAll('[data-delete-notice]').forEach(btn => {
                    btn.onclick = () => {
                        const noticeId = parseInt(btn.getAttribute('data-delete-notice'));
                        // Ensure parseInt works correctly
                        if (isNaN(noticeId)) {
                             console.error("Invalid notice ID for deletion.");
                             return;
                        }
                        if (confirm('Are you sure you want to permanently delete this notice?')) {
                            this.handleDeleteNotice(noticeId);
                        }
                    };
                });

                // Item Delete Buttons (Memes/Memories)
                document.querySelectorAll('[data-delete-item]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-delete-item'));
                        const type = btn.getAttribute('data-type');
                        if (confirm(`ADMIN WARNING: Are you sure you want to permanently delete this ${type} and its file from storage?`)) {
                            this.handleDeleteItem(itemId, type);
                        }
                    };
                });


                const emailInput = document.getElementById('emailInput');
                if (emailInput) emailInput.oninput = (e) => { this.state.email = e.target.value; };

                const passwordInput = document.getElementById('passwordInput');
                if (passwordInput) passwordInput.oninput = (e) => { this.state.password = e.target.value; };

                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.onchange = (e) => this.handleFileUpload(e.target.files[0], this.state.currentTab === 'memories' ? 'memory' : 'meme');

                document.querySelectorAll('[data-tab]').forEach(btn => {
                    btn.onclick = () => {
                        this.state.currentTab = btn.getAttribute('data-tab');
                        if (this.state.currentTab !== 'notices') {
                             this.loadAllData();
                        } else {
                            this.loadNotices();
                        }
                        this.render();
                    };
                });
                
                document.querySelectorAll('[data-scroll]').forEach(btn => {
                    btn.onclick = () => {
                        const type = btn.getAttribute('data-scroll');
                        const direction = btn.getAttribute('data-direction');
                        if (type === 'meme') {
                            this.scrollMemes(direction);
                        } else {
                            this.scrollMemories(direction);
                        }
                    };
                });

                document.querySelectorAll('[data-promote]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-promote'));
                        const type = btn.getAttribute('data-type');
                        const items = type === 'memory' ? this.state.memories : this.state.memes;
                        const item = items.find(m => m.id === itemId);
                        if (item) this.promoteToHallOfFame(item, type);
                    };
                });

                document.querySelectorAll('[data-remove-hof]').forEach(btn => {
                    btn.onclick = () => {
                        const itemId = parseInt(btn.getAttribute('data-remove-hof'));
                        const type = btn.getAttribute('data-type');
                        this.removeFromHallOfFame(itemId, type);
                    };
                });
            }
            
            // Auto-scroll and manual scroll functions (omitted for brevity, they are unchanged)
            scrollMemes(direction) { 
                const container = document.getElementById('meme-scroll-container');
                if (!container) return;
                const totalItems = this.state.hallOfFameMemes.length;
                let newIndex = this.state.memeScrollIndex;

                if (direction === 'next') {
                    newIndex = (newIndex + 1) % totalItems;
                } else if (direction === 'prev') {
                    newIndex = (newIndex - 1 + totalItems) % totalItems;
                }
                
                this.state.memeScrollIndex = newIndex;
                this.render(); 
            }

            scrollMemories(direction) { 
                const container = document.getElementById('memory-scroll-container');
                if (!container) return;
                const totalItems = this.state.hallOfFameMemories.length;
                let newIndex = this.state.memoryScrollIndex;

                if (direction === 'next') {
                    newIndex = (newIndex + 1) % totalItems;
                } else if (direction === 'prev') {
                    newIndex = (newIndex - 1 + totalItems) % totalItems;
                }

                this.state.memoryScrollIndex = newIndex;
                this.render(); 
            }

            startAutoScroll() {
                if (this.memeScrollInterval) clearInterval(this.memeScrollInterval);
                this.memeScrollInterval = setInterval(() => {
                    if (this.state.currentTab === 'memes') {
                        this.scrollMemes('next');
                    }
                }, 5000);

                if (this.memoryScrollInterval) clearInterval(this.memoryScrollInterval);
                this.memoryScrollInterval = setInterval(() => {
                    if (this.state.currentTab === 'memories') {
                        this.scrollMemories('next');
                    }
                }, 5000);
            }
        }

        new MemeGallery();
    </script>
</body>
</html>
